name: Sync Google Sheets to CSV (Keyless Auth)

on:
  # Scheduled trigger - daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # TODO: Remove after testing
  push:
    branches: ['add-sheet2csv-automation']

  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip PR creation)'
        required: false
        default: false
        type: boolean

# Required permissions
permissions:
  contents: write
  pull-requests: write
  id-token: write  # Required for OIDC token authentication

jobs:
  sync-sheet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for better diffs

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/sheet2docs/requirements.txt

      # Keyless authentication using Workload Identity Federation
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT_EMAIL }}
          project_id: ${{ vars.GCP_PROJECT_ID }}
          access_token_scopes: 'https://www.googleapis.com/auth/spreadsheets.readonly,https://www.googleapis.com/auth/drive.readonly'

      # The auth action sets GOOGLE_APPLICATION_CREDENTIALS automatically
      - name: Run sync script
        env:
          GOOGLE_SHEET_URL: ${{ secrets.GOOGLE_SHEET_URL }}
        run: |
          python scripts/sheet2docs/sync_sheet.py --config scripts/sheet2docs/config.yml --verbose

      - name: Check for changes
        id: check_changes
        run: |
          CSV_PATH="explore-analyze/elastic-inference/models.csv"

          # Check if file is new (untracked) or modified
          is_new=false
          is_modified=false

          if [ -f "$CSV_PATH" ]; then
            # Check if file is untracked (new)
            if ! git ls-files --error-unmatch "$CSV_PATH" &>/dev/null; then
              is_new=true
              echo "New CSV file detected"
            # Check if file has modifications
            elif ! git diff --quiet "$CSV_PATH"; then
              is_modified=true
              echo "CSV file has been modified"
            fi
          fi

          if [ "$is_new" = true ] || [ "$is_modified" = true ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in CSV file"

            # Get row count from CSV (subtract 1 for header)
            row_count=$(($(wc -l < "$CSV_PATH") - 1))
            echo "row_count=${row_count}" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in CSV file"
          fi

      - name: Create or Update Pull Request
        if: steps.check_changes.outputs.changed == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Use fixed branch name
          branch_name="automated/sheets-sync"
          CSV_PATH="explore-analyze/elastic-inference/models.csv"

          # Check if branch exists on remote
          if git ls-remote --exit-code --heads origin "$branch_name" &>/dev/null; then
            echo "Branch exists, updating..."
            git fetch origin "$branch_name"
            git checkout -B "$branch_name" "origin/$branch_name"
            git add "$CSV_PATH"
            git commit -m "Update CSV from Google Sheets

          Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Workflow run: ${{ github.run_number }}

          [skip ci]"
            git push origin "$branch_name"
            echo "Branch updated. Existing PR will be updated automatically."
          else
            echo "Branch does not exist, creating new branch and PR..."
            git checkout -b "$branch_name"
            git add "$CSV_PATH"
            git commit -m "Update CSV from Google Sheets

          Generated: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Workflow run: ${{ github.run_number }}

          [skip ci]"
            git push origin "$branch_name"

            # Get CSV info for PR body
            csv_file="$CSV_PATH"
            csv_filename=$(basename "$csv_file")
            row_count=${{ steps.check_changes.outputs.row_count }}
            col_count=$(head -n 1 "$csv_file" | awk -F',' '{print NF}')

            # Create PR with gh CLI
            gh pr create \
              --title "Update CSV from Google Sheets" \
              --body "## Summary

          This PR updates the CSV file with the latest data from Google Sheets.

          **File:** \`${csv_filename}\`
          **Rows:** ${row_count}
          **Columns:** ${col_count}
          **Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          ### Changes

          Please review the changes in the Files tab to ensure the data looks correct.

          ### Next Steps

          - [ ] Review the CSV changes
          - [ ] Verify data accuracy
          - [ ] Merge when ready

          ---

          ðŸ¤– Automated update from [sync-sheets workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
              --head "$branch_name" \
              --base main
          fi

      - name: Upload CSV artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: generated-csv-${{ github.run_number }}
          path: explore-analyze/elastic-inference/models.csv
          retention-days: 30
          if-no-files-found: warn

      - name: Generate job summary
        if: always()
        run: |
          CSV_PATH="explore-analyze/elastic-inference/models.csv"
          echo "## Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Detected:** ${{ steps.check_changes.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "$CSV_PATH" ]; then
            echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh "$CSV_PATH" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show first few rows as preview
            echo "### Preview (first 5 rows)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`csv" >> $GITHUB_STEP_SUMMARY
            head -n 6 "$CSV_PATH" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No CSV file found" >> $GITHUB_STEP_SUMMARY
          fi
