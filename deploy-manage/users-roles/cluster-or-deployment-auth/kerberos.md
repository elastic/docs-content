---
mapped_urls:
  - https://www.elastic.co/guide/en/cloud-enterprise/current/ece-secure-clusters-kerberos.html
  - https://www.elastic.co/guide/en/cloud/current/ec-secure-clusters-kerberos.html
  - https://www.elastic.co/guide/en/cloud-heroku/current/ech-secure-clusters-kerberos.html
  - https://www.elastic.co/guide/en/elasticsearch/reference/current/kerberos-realm.html
navigation_title: Kerberos
applies_to:
  deployment:
    self:
    ess:
    ece:
    eck:
---

# Kerberos authentication [kerberos-realm]

You can configure the {{stack}} {{security-features}} to support Kerberos V5 authentication, an industry standard protocol to authenticate users in {{es}} and {{kib}}.

::::{note} 
You can't use the Kerberos realm to authenticate on the transport network layer.
::::


To authenticate users with Kerberos, you need to configure a Kerberos realm and map users to roles. For more information on realm settings, see [Kerberos realm settings](asciidocalypse://docs/elasticsearch/docs/reference/elasticsearch/configuration-reference/security-settings.md#ref-kerberos-settings).

## Key concepts [kerberos-terms]

There are a few terms and concepts that you’ll encounter when you’re setting up Kerberos realms:

kdc
:   Key Distribution Center. A service that issues Kerberos tickets.

principal
:   A Kerberos principal is a unique identity to which Kerberos can assign tickets. It can be used to identify a user or a service provided by a server.

    Kerberos V5 principal names are of format `primary/instance@REALM`, where `primary` is a user name.

    `instance` is an optional string that qualifies the primary and is separated by a slash(`/`) from the primary. For a user, usually it is not used; for service hosts, it is the fully qualified domain name of the host.

    `REALM` is the Kerberos realm. Usually it is the domain name in upper case. An example of a typical user principal is `user@ES.DOMAIN.LOCAL`. An example of a typical service principal is `HTTP/es.domain.local@ES.DOMAIN.LOCAL`.


realm
:   Realms define the administrative boundary within which the authentication server has authority to authenticate users and services.

keytab
:   A file that stores pairs of principals and encryption keys.

    ::::{important} 
    Anyone with read permissions to this file can use the credentials in the network to access other services so it is important to protect it with proper file permissions.
    ::::


krb5.conf
:   A file that contains Kerberos configuration information such as the default realm name, the location of Key distribution centers (KDC), realms information, mappings from domain names to Kerberos realms, and default configurations for realm session key encryption types.

ticket granting ticket (TGT)
:   A TGT is an authentication ticket generated by the Kerberos authentication server. It contains an encrypted authenticator.


## Configuring a Kerberos realm [kerberos-realm-configuration]

Kerberos is used to protect services and uses a ticket-based authentication protocol to authenticate users. You can configure {{es}} to use the Kerberos V5 authentication protocol, which is an industry standard protocol, to authenticate users. In this scenario, clients must present Kerberos tickets for authentication.

In Kerberos, users authenticate with an authentication service and later with a ticket granting service to generate a TGT (ticket-granting ticket). This ticket is then presented to the service for authentication. Refer to your Kerberos installation documentation for more information about obtaining TGT. {{es}} clients must first obtain a TGT then initiate the process of authenticating with {{es}}.

### Prerequisites [kerberos-realm-prereq]

Before you set up a Kerberos realm, you must have the Kerberos infrastructure set up in your environment.

::::{note} 
Kerberos requires a lot of external services to function properly, such as time synchronization between all machines and working forward and reverse DNS mappings in your domain. Refer to your Kerberos documentation for more details.
::::

These instructions do not cover setting up and configuring your Kerberos deployment. Where examples are provided, they pertain to an MIT Kerberos V5 deployment. For more information, see [MIT Kerberos documentation](http://web.mit.edu/kerberos/www/index.md)

If you're using a self-managed cluster, then perform the following additional steps: 

* Enable TLS for HTTP.

    If your {{es}} cluster is operating in production mode, you must configure the HTTP interface to use SSL/TLS before you can enable Kerberos authentication. For more information, see [Encrypt HTTP client communications for {{es}}](../../../deploy-manage/security/set-up-basic-security-plus-https.md#encrypt-http-communication).

    This step is necessary to support Kerberos authentication through {{kib}}. It is not required for Kerberos authentication directly against the {{es}} Rest API.

    If you started {{es}} [with security enabled](/deploy-manage/deploy/self-managed/installing-elasticsearch.md), then TLS is already enabled for HTTP. 

    {{ech}}, {{ece}}, and {{eck}} have TLS enabled by default.

* Enable the token service.

    The {{es}} Kerberos implementation makes use of the {{es}} token service. If you configure TLS on the HTTP interface, this service is automatically enabled. It can be explicitly configured by adding the following setting in your `elasticsearch.yml` file:

    ```yaml
    xpack.security.authc.token.enabled: true
    ```
    This step is necessary to support Kerberos authentication through {{kib}}. It is not required for Kerberos authentication directly against the {{es}} Rest API.

    {{ech}}, {{ece}}, and {{eck}} have TLS enabled by default.



### Create a Kerberos realm [kerberos-realm-create]

To configure a Kerberos realm in {{es}}:

#### Prepare Kerberos config files

{{es}} uses Java GSS framework support for Kerberos authentication. To support Kerberos authentication, {{es}} needs the following files:

   * `krb5.conf`: The Kerberos configuration file (`krb5.conf`) provides information such as the default realm, the Key Distribution Center (KDC), and other configuration details required for Kerberos authentication. For more information, see [krb5.conf](https://web.mit.edu/kerberos/krb5-latest/doc/admin/conf_files/krb5_conf.html).
   * `keytab`: A keytab is a file that stores pairs of principals and encryption keys. {{es}} uses the keys from the keytab to decrypt the tickets presented by the user. You must create a keytab for {{es}} by using the tools provided by your Kerberos implementation. For example, some tools that create keytabs are `ktpass.exe` on Windows and `kadmin` for MIT Kerberos.
  
The configuration requirements depend on your Kerberos setup. Refer to your Kerberos documentation to configure the `krb5.conf` file.

For more information on Java GSS, see [Java GSS Kerberos requirements](https://docs.oracle.com/javase/10/security/kerberos-requirements1.htm).

#### Configure {{es}}

The way that you provide Kerberos config files to {{es}} depends on your deployment method.

For detailed information of available realm settings, see [Kerberos realm settings](asciidocalypse://docs/elasticsearch/docs/reference/elasticsearch/configuration-reference/security-settings.md#ref-kerberos-settings).

:::::{tab-set}

::::{tab-item} Self-managed

1. Configure the JVM to find the Kerberos configuration file.
   
   {{es}} uses Java GSS and JAAS Krb5LoginModule to support Kerberos authentication using a Simple and Protected GSSAPI Negotiation (SPNEGO) mechanism. When the JVM needs some configuration properties, it tries to find those values by locating and loading the `krb5.conf` file. The JVM system property to configure the file path is `java.security.krb5.conf`. To configure JVM system properties see [Set JVM options](asciidocalypse://docs/elasticsearch/docs/reference/elasticsearch/jvm-settings.md#set-jvm-options). If this system property is not specified, Java tries to locate the file based on the conventions.
   
   :::{tip} 
   It is recommended that this system property be configured for {{es}}. The method for setting this property depends on your Kerberos infrastructure. Refer to your Kerberos documentation for more details.
   :::

   For more information, see [krb5.conf](https://web.mit.edu/kerberos/krb5-latest/doc/admin/conf_files/krb5_conf.html).

2. Put the keytab file in the {{es}} configuration directory.
   
   Make sure that this keytab file has read permissions. This file contains credentials, therefore you must take appropriate measures to protect it.
   
   :::{important} 
   {{es}} uses Kerberos on the HTTP network layer, therefore there must be a keytab file for the HTTP service principal on every {{es}} node. The service principal name must have the format `HTTP/es.domain.local@ES.DOMAIN.LOCAL`. The keytab files are unique for each node since they include the hostname. An {{es}} node can act as any principal a client requests as long as that principal and its credentials are found in the configured keytab.
   :::

3. Create a Kerberos realm.
   
   To enable Kerberos authentication in {{es}}, you must add a Kerberos realm in the realm chain.
   
   :::{note}
   You can configure only one Kerberos realm on {{es}} nodes.
   :::

   To configure a Kerberos realm, there are a few mandatory realm settings and other optional settings that you need to configure in the `elasticsearch.yml` configuration file. Add a realm configuration under the `xpack.security.authc.realms.kerberos` namespace.

   The most common configuration for a Kerberos realm is as follows:
   
   ```yaml
   xpack.security.authc.realms.kerberos.kerb1:
    order: 3
    keytab.path: es.keytab
    remove_realm_name: false
   ```
4. Restart {{es}}.
::::

::::{tab-item} ECH and ECE

1. Create a [custom bundle](asciidocalypse://docs/elasticsearch/docs/reference/elasticsearch-plugins/cloud-enterprise/ece-add-plugins.md) that contains your `krb5.conf` and `keytab` files, and add it to your cluster.

    :::{tip}
    You should use these exact filenames for {{ecloud}} to recognize the file in the bundle.
    ::::

2. Edit your cluster configuration, sometimes also referred to as the deployment plan, to define  your Kerberos settings:

    ```sh
    xpack.security.authc.realms.kerberos.cloud-krb:
       order: 2
       keytab.path: es.keytab
       remove_realm_name: false
    ```

    ::::{important}
    The name of the realm must be `cloud-krb`, and the order must be 2: `xpack.security.authc.realms.kerberos.cloud-krb.order: 2`
    ::::
::::

::::{tab-item} ECK

1. Install your `krb5.conf` and `keytab` files as a [custom configuration files](/deploy-manage/deploy/cloud-on-k8s/custom-configuration-files-plugins.md#use-a-volume-and-volume-mount-together-with-a-configmap-or-secret). Mount them in a sub-directory of the main config directory, for example `/usr/share/elasticsearch/config/kerberos`, and use a `Secret` instead of a `ConfigMap` to store the information.

2. Configure the JVM to find the Kerberos configuration file.
   
   {{es}} uses Java GSS and JAAS Krb5LoginModule to support Kerberos authentication using a Simple and Protected GSSAPI Negotiation (SPNEGO) mechanism. When the JVM needs some configuration properties, it tries to find those values by locating and loading the `krb5.conf` file. The JVM system property to configure the file path is `java.security.krb5.conf`. If this system property is not specified, Java tries to locate the file based on the conventions.

   To provide JVM setting overrides to your cluster:

   1. Create a new ConfigMap with a valid JVM options file as the key. The source file should be a JVM `.options` file containing the JVM system property `-Djava.security.krb5.conf=/usr/share/elasticsearch/config/kerberos/krb5.conf`, assuming the `krb5.conf` file was mounted on `/usr/share/elasticsearch/config/kerberos` in the previous step.
   
    ```
    # create a configmap with a key named override.options and the content of your local file
    kubectl create configmap jvm-options --from-file=override.options=<your-local-file>
    ```

   2. Reference the ConfigMap in your [cluster specification](/deploy-manage/deploy/cloud-on-k8s/update-deployments.md):

        ```yaml
        apiVersion: elasticsearch.k8s.elastic.co/v1
        kind: Elasticsearch
        metadata:
        name: test-cluster 
        spec:
        version: 8.17.0
        nodeSets:
        - name: default
            count: 3
            config:
            # this allows ES to run on nodes even if their vm.max_map_count has not been increased, at a performance cost
            node.store.allow_mmap: false
            podTemplate:
            spec:
                containers:
                - name: elasticsearch
                  volumeMounts:
                    - name: jvm-opts
                      mountPath: /usr/share/elasticsearch/config/jvm.options.d
                    - name: krb5
                      mountPath: /usr/share/elasticsearch/config/kerberos
               volumes:
               - name: jvm-opts
                 configMap:
                   name: jvm-options
               - name: krb5
                 secret:
                   name: kerberos-secret
        ```

3. Edit your cluster configuration to define your Kerberos settings:

    ```yaml
    xpack.security.authc.realms.kerberos.cloud-krb:
       order: 2
       keytab.path: kerberos/keytab
       remove_realm_name: false
    ```
::::

:::::

The `username` is extracted from the ticket presented by the user and usually has the format `username@REALM`. This `username` is used for mapping roles to the user. If realm setting `remove_realm_name` is set to `true`, the realm part (`@REALM`) is removed.

## Map Kerberos users to roles


The `kerberos` realm enables you to map Kerberos users to roles. 

You can map these users to roles in multiple ways: 

* Using the role mappings page in {{kib}}.
* Using the [role mapping API](https://www.elastic.co/docs/api/doc/elasticsearch/operation/operation-security-put-role-mapping). 

You identify users by their `username` field.

The following example uses the role mapping API to map `user@REALM` to the roles `monitoring` and `user`:

```console
POST /_security/role_mapping/kerbrolemapping
{
  "roles" : [ "monitoring_user" ],
  "enabled": true,
  "rules" : {
    "field" : { "username" : "user@REALM" }
  }
}
```

In case you want to support Kerberos cross realm authentication, you may need to map roles based on the Kerberos realm name. For such scenarios, the following additional user metadata can be used for role mapping: 

- `kerberos_realm`: The Kerberos realm name. 
- `kerberos_user_principal_name`: The user principal name from the Kerberos ticket.

For more information, see [Mapping users and groups to roles](/deploy-manage/users-roles/cluster-or-deployment-auth/mapping-users-groups-to-roles.md).

::::{note} 
The Kerberos realm supports [authorization realms](/deploy-manage/users-roles/cluster-or-deployment-auth/realm-chains.md#authorization_realms) as an alternative to role mapping.
::::

## Use Kerberos authentication for {{kib}} [kerberos-realm-kibana]

If you want to use Kerberos to authenticate using your browser and {{kib}}, you need to enable the relevant authentication provider in {{kib}} configuration. See [Kerberos single sign-on](/deploy-manage/users-roles/cluster-or-deployment-auth/kibana-authentication.md#kerberos).
